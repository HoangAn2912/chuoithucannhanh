<?php
// Database connection class
class ketnoi {
    private $host = "localhost";
    private $user = "root";
    private $pass = "";
    private $db = "cuahangthucan_db";
    private $conn;
    public function ketnoi() {
        $this->conn = new mysqli($this->host, $this->user, $this->pass, $this->db);
        if ($this->conn->connect_error) {
            die("Kết nối không thành công: " . $this->conn->connect_error);
        } else {
            return $this->conn;
        }
    }
}

// Model class for attendance
class mChamCong {
    private $conn;

    public function __construct() {
        $ketnoi = new ketnoi();
        $this->conn = $ketnoi->ketnoi();
    }

    public function getEmployees($mach) {
        $sql = "SELECT nguoidung.tennd, vaitro.tenvaitro, nhanvienbanhang.mand AS manvbh, nhanvienbep.mand AS manvb
                FROM nguoidung
                LEFT JOIN vaitro ON nguoidung.mavaitro = vaitro.mavaitro
                LEFT JOIN nhanvienbanhang ON nguoidung.mand = nhanvienbanhang.mand
                LEFT JOIN nhanvienbep ON nguoidung.mand = nhanvienbep.mand
                WHERE nguoidung.mach = ? AND (vaitro.mavaitro = 3 OR vaitro.mavaitro = 4)";
        $stmt = $this->conn->prepare($sql);
        $stmt->bind_param("i", $mach);
        $stmt->execute();
        $result = $stmt->get_result();
        $employees = [];
        while ($row = $result->fetch_assoc()) {
            $employees[] = $row;
        }
        return $employees;
    }

    public function getEmployeeById($employeeId) {
        $sql = "SELECT nhanvienbanhang.mand AS manvbh, nhanvienbep.mand AS manvb
                FROM nguoidung
                LEFT JOIN nhanvienbanhang ON nguoidung.mand = nhanvienbanhang.mand
                LEFT JOIN nhanvienbep ON nguoidung.mand = nhanvienbep.mand
                WHERE nguoidung.mand = ?";
        $stmt = $this->conn->prepare($sql);
        $stmt->bind_param("i", $employeeId);
        $stmt->execute();
        $result = $stmt->get_result();
        return $result->fetch_assoc();
    }

    public function getShifts() {
        $sql = "SELECT macalam, tenca FROM calam";
        $result = $this->conn->query($sql);
        $shifts = [];
        while ($row = $result->fetch_assoc()) {
            $shifts[] = $row;
        }
        return $shifts;
    }

    public function saveAttendance($employeeId, $status, $note, $date, $time, $shiftId) {
        $manvbh = $employeeId['manvbh'] ?? 0;
        $manvb = $employeeId['manvb'] ?? 0;
        $sql = "INSERT INTO chamcong (manvb, manvbh, macalam, ngaychamcong, thoigianvao, trangthai, ghichu) VALUES (?, ?, ?, ?, ?, ?, ?)";
        $stmt = $this->conn->prepare($sql);
        if ($stmt === false) {
            die('Prepare failed: ' . htmlspecialchars($this->conn->error));
        }
        $stmt->bind_param("iiissss", $manvb, $manvbh, $shiftId, $date, $time, $status, $note);
        if (!$stmt->execute()) {
            die('Execute failed: ' . htmlspecialchars($stmt->error));
        }
    }
}

// Controller class for attendance
class cChamCong {
    private $model;

    public function __construct() {
        $this->model = new mChamCong();
    }

    public function getEmployees($mach) {
        return $this->model->getEmployees($mach);
    }

    public function getShifts() {
        return $this->model->getShifts();
    }

    public function saveAttendance($data) {
        foreach ($data as $employeeId => $attendance) {
            $status = $attendance['status'] ?? 'absent';
            $note = $attendance['note'] ?? '';
            $date = date('Y-m-d');
            $time = date('H:i:s');
            $shiftId = $attendance['shift'] ?? 0;
            
            // Lấy thông tin nhân viên
            $employee = $this->model->getEmployeeById($employeeId);
            
            // Xác định mã nhân viên bán hàng và mã nhân viên bếp
            $manvbh = $employee['manvbh'] ?? 0;
            $manvb = $employee['manvb'] ?? 0;
            
            // Kiểm tra loại nhân viên và đặt giá trị tương ứng
            if ($manvbh != 0) {
                $this->model->saveAttendance(['manvb' => 0, 'manvbh' => $manvbh], $status, $note, $date, $time, $shiftId);
            } else {
                $this->model->saveAttendance(['manvb' => $manvb, 'manvbh' => 0], $status, $note, $date, $time, $shiftId);
            }
        }
    }
}

// Simulate logged-in manager's store ID
$loggedInManagerStoreId = 1; // This should be dynamically set based on the logged-in manager

// Main script
$cChamCong = new cChamCong();
$employees = $cChamCong->getEmployees($loggedInManagerStoreId);
$shifts = $cChamCong->getShifts();

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $attendanceData = [];
    foreach ($_POST as $key => $value) {
        if (strpos($key, 'status_') === 0) {
            $employeeId = str_replace('status_', '', $key);
            $attendanceData[$employeeId]['status'] = $value;
        } elseif (strpos($key, 'note_') === 0) {
            $employeeId = str_replace('note_', '', $key);
            $attendanceData[$employeeId]['note'] = $value;
        } elseif (strpos($key, 'shift_') === 0) {
            $employeeId = str_replace('shift_', '', $key);
            $attendanceData[$employeeId]['shift'] = $value;
        }
    }
    $cChamCong->saveAttendance($attendanceData);
}
?>

    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Quản lý nhân viên</title>
        <link rel="stylesheet" href="css/ChamCong/style.css">
        <link rel="stylesheet" href="css/QLNV/style.css">
        <link rel="stylesheet" href="css/ChamCong/styles.css">
    </head>
    <body>
        <?php require('layout/navqlch.php'); ?>
        <div class="main">
            <div class="title">
                <h2>Chấm Công Nhân Viên</h2>
            </div>
            <div class="cc-search-bar">
                <form method="POST">
                    <input class="cc-input" type="text" name="search" placeholder="Nhập nhân viên cần tìm..." />
                    <button class="cc-submit" type="submit"><i class="fas fa-search"></i> Tìm</button>
                </form>
            </div>
            <!-- <div class="branch-selector">  
                <label for="branch">Chọn ca làm</label>  
                <select id="branch" name="branch" onchange="this.form.submit()">  
                    <option value="branch1">Ca sáng</option>  
                    <option value="branch2">Ca trưa</option>  
                    <option value="branch3">Ca chiều</option>  
                    <option value="branch3">Ca tối</option> 
                </select>  
            </div>   -->
            <form method="POST">
            <div class="title-dsnv">
                <h3>Danh sách nhân viên</h3>
            </div>
            <div class="list-dsnv">
                <table class="employee-list title-list">
                    <thead>
                        <tr>
                            <th>Tên nhân viên</th>
                            <th>Chức vụ</th>
                            <th>Ngày chấm công</th>
                            <th>Ca làm</th>
                            <th>Trạng thái</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="employee-list">
                        <?php foreach ($employees as $employee): ?>
                        <tr>
                            <td><?php echo $employee['tennd']; ?></td>
                            <td><?php echo $employee['tenvaitro']; ?></td>
                            <td><input type="date" name="date" value="<?php echo date('Y-m-d'); ?>" readonly></td>
                            <td>
                                <select name="shift_<?php echo $employee['manvbh'] ?? $employee['manvb']; ?>">
                                    <?php foreach ($shifts as $shift): ?>
                                        <option value="<?php echo $shift['macalam']; ?>"><?php echo $shift['tenca']; ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </td>
                            <td class="check-box status-present">
                                <label><input type="radio" name="status_<?php echo $employee['manvbh'] ?? $employee['manvb']; ?>" value="có mặt" required> Có mặt</label>
                                <label><input type="radio" name="status_<?php echo $employee['manvbh'] ?? $employee['manvb']; ?>" value="vắng" required> Vắng mặt</label>
                            </td>
                            <td><textarea name="note_<?php echo $employee['manvbh'] ?? $employee['manvb']; ?>" class="notes-input" placeholder="Ghi chú..."></textarea></td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="submit-ChamCong" type="submit">Lưu thông tin chấm công</button>
            </div>
            </form> 
        </div>
    </body>
    </html>
